name: VoltAI Supervisor

on:
  workflow_dispatch:
    inputs:
      talimat:
        description: "Ne yapılsın? (ör: günlük rapor oluştur, kaynak ekle: ...)"
        required: true
        type: string

permissions:
  contents: write

jobs:
  apply:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Talimatı oku
        id: read
        run: |
          echo "TALIMAT=${{ github.event.inputs.talimat }}" >> $GITHUB_ENV
          echo "Kullanıcı talimatı: ${{ github.event.inputs.talimat }}"

      - name: Ortamı hazırla
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq
          mkdir -p data
touch data/panel.json
      - name: panel.json oluştur (yoksa)
        run: |
          if [ ! -f data/panel.json ]; then
            echo '{"totals":{"records":0,"new24h":0,"completionPct":0},"updatedAt":"1970-01-01T00:00:00Z"}' > data/panel.json
          fi

      - name: Günlük rapor oluştur
        if: contains(env.TALIMAT, 'günlük rapor')
        run: |
          DATE=$(date -u +"%Y-%m-%d")
          jq --arg d "$DATE" '.dailyReport.date=$d | .updatedAt=now | todate' data/panel.json > data/tmp.json
          mv data/tmp.json data/panel.json
          echo "✅ Günlük rapor oluşturuldu."

      - name: Kaynak ekle
        if: contains(env.TALIMAT, 'kaynak ekle')
        run: |
          LIST=$(echo "${{ github.event.inputs.talimat }}" | sed 's/.*kaynak ekle://i' | tr ',' '\n' | sed 's/^ *//;s/ *$//' | jq -R . | jq -s .)
          jq --argjson arr "$LIST" '.dailyReport.newSourcesTop10 += $arr' data/panel.json > data/tmp.json
          mv data/tmp.json data/panel.json
          echo "✅ Kaynaklar eklendi: $LIST"

      - name: Commit & Push
        run: |
          git config user.name "VoltAI Supervisor"
          git config user.email "operator@users.noreply.github.com"
          git add -A
          git diff --cached --quiet || git commit -m "auto: VoltAI Supervisor güncelleme"
          git push
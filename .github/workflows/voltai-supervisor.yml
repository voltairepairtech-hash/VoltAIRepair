name: VoltAI Supervisor

on:
  workflow_dispatch:
    inputs:
      talimat:
        description: "Ne yapÄ±lsÄ±n? (Ã¶r: gÃ¼nlÃ¼k rapor oluÅŸtur, kaynak ekle: ...)"
        required: true
        type: string

permissions:
  contents: write

jobs:
  apply:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: TalimatÄ± oku
        id: read
        run: |
          echo "TALIMAT=${{ github.event.inputs.talimat }}" >> $GITHUB_ENV
          echo "ðŸ“¥ KullanÄ±cÄ± talimatÄ±: ${{ github.event.inputs.talimat }}"

      - name: OrtamÄ± hazÄ±rla
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq
          mkdir -p data
          touch data/panel.json

      - name: panel.json oluÅŸtur (yoksa)
        run: |
          if [ ! -f data/panel.json ]; then
            echo '{"totals":{"records":0,"new24h":0,"completionPct":0},"updatedAt":"1970-01-01T00:00:00Z"}' > data/panel.json
          fi

      - name: GÃ¼nlÃ¼k rapor oluÅŸtur
        if: contains(env.TALIMAT, 'gÃ¼nlÃ¼k rapor')
        run: |
          DATE=$(date -u +"%Y-%m-%d")
          jq --arg d "$DATE" '.dailyReport.date=$d | .updatedAt=$d' data/panel.json > data/tmp.json
          mv data/tmp.json data/panel.json
          echo "âœ… GÃ¼nlÃ¼k rapor oluÅŸturuldu ($DATE)."

      - name: Kaynak ekle
        if: contains(env.TALIMAT, 'kaynak ekle')
        run: |
          LIST=$(echo "${{ github.event.inputs.talimat }}" | sed 's/.*kaynak ekle://i' | tr ',' '\n' | sed 's/^ *//;s/ *$//' | jq -R . | jq -s .)
          jq --argjson arr "$LIST" '.dailyReport.newSourcesTop10 += $arr' data/panel.json > data/tmp.json
          mv data/tmp.json data/panel.json
          echo "âœ… Kaynaklar eklendi: $LIST"

      - name: Commit & Push
        run: |
          git config user.name "VoltAI Supervisor"
          git config user.email "operator@users.noreply.github.com"
          git add -A
          git diff --cached --quiet || git commit -m "auto: VoltAI Supervisor gÃ¼ncelleme"
          git push
          echo "ðŸš€ GÃ¼ncelleme gÃ¶nderildi."